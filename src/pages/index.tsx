import { Box, Button, Flex, FormControl, FormLabel, Input, theme } from '@chakra-ui/react'
import type { NextPage } from 'next'
import Head from 'next/head'
import { useState } from 'react'
import { Controller, useFieldArray, useForm } from 'react-hook-form'
import Header from '../components/Header'
import StockInput from '../components/StockInput'

type Stock = {
  name: string,
  total: string,
  price: string,
  percentage: string
}

type FormValues = {
  stocks: Stock[],
  newValue: string
}

type Report = {
  name: string,
  operation: number
}

const Home: NextPage = () => {
  const [report, setReport] = useState<Report[]>([])
  const { control, handleSubmit, register, formState: { errors } } = useForm<FormValues>()
  const { fields, append, remove } = useFieldArray({
    control,
    name: 'stocks'
  })

  const addStock = () => {
    append({
      name: '',
      total: '',
      price: '',
      percentage: ''
    })
  }

  const generateReport = ({ stocks, newValue }: FormValues) => {
    const total = Number(newValue) + stocks.reduce((total, stock) => total + Number(stock.total), 0)
    const report = stocks.map(stock => {
      const estimatedValue = total * Number(stock.percentage)
      console.log(total, estimatedValue)
      const difference = estimatedValue - Number(stock.total)
      const numberOsStocksToNegotiate = Math.round(difference / Number(stock.price))
      return {
        name: stock.name,
        operation: numberOsStocksToNegotiate
      }
    })
    setReport(report)
  }

  console.log(errors)

  return (
    <div>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Header />

      <br />

      <Box as="main" padding="0px 20px">
        <form onSubmit={handleSubmit(generateReport)}>
          <FormControl isInvalid={!!errors.newValue}>
            <FormLabel>Valor aportado</FormLabel>
            <Controller
              name="newValue"
              defaultValue={'0'}
              control={control}
              render={({ field }) => (
                <Input {...field} />
              )} />
          </FormControl>

          <br />
          <hr />
          <br />

          <Flex flexDirection="column" gap="16px">

            {fields.map((field, index) =>
              <StockInput
                key={field.id}
                name={`stocks.${index}`}
                register={register}
                onRemove={() => remove(index)}
                errors={errors.stocks?.[index] as any}
              />
            )}
          </Flex>

          <br />

          <Flex gap="15px">
            <Button
              bgColor={theme.colors.blue[500]}
              color={theme.colors.white}
              type="button"
              onClick={addStock}
            >
              Adicionar
            </Button>
            <Button
              bgColor={theme.colors.green[500]}
              color={theme.colors.white}
              type="submit"
            >
              Calcular
            </Button>
          </Flex>
        </form>

        <br />
        <br />

        {report.map(({ name, operation }, index) => (
          <p key={index}><b>{name}</b>: {operation}</p>
        ))}
      </Box>
    </div >
  )
}

export default Home
